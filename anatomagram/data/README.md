# Anatomagram Data Mappings

## Overview
Visualization mappings that extend the core `vocabs/tissue_vocab.yaml` with anatomical ontology IDs, SVG element mappings, and hierarchy fallbacks.

## Primary Mapping File

### tissue_mapping_enhanced.json
**Single source of truth** for anatomagram visualization.

#### Structure
```json
{
  "tissue_mappings": {
    "7": {  // Tissue ID from vocabs/tissue_vocab.yaml
      "tissue_name": "adipose - subcutaneous",      // From tissue_vocab
      "tissue_type": "tissue",                      // Type classification
      "uberon_id": "UBERON_0002190",                // Anatomical ontology ID
      "display_name": "Subcutaneous Adipose Tissue", // UI display name
      "svg_uberon_id": "UBERON_0001013",            // SVG element ID to color
      "is_direct_match": false,                     // true = exact match, false = hierarchy fallback
      "can_visualize": true                         // Has corresponding SVG element
    }
  },
  "hierarchy_fallbacks": {
    "UBERON_0002190": "UBERON_0001013"  // Specific tissue → general tissue
  },
  "cell_line_mappings": {
    // Cell lines (excluded from anatomagram visualization)
  }
}
```

#### Key Concepts

**Direct Match vs Hierarchy Fallback**:
- **Direct match** (`is_direct_match: true`): Tissue has exact SVG element
  - Example: `brain - cortex` → `UBERON_0000955` (cerebral cortex SVG element)
- **Hierarchy fallback** (`is_direct_match: false`): Tissue maps to parent anatomical structure
  - Example: `adipose - subcutaneous` → `UBERON_0001013` (generic adipose tissue SVG)

**Why Hierarchy Fallbacks?**

SVG anatomagrams show broad anatomical structures, but model predicts on specific tissues. Hierarchy fallbacks ensure all predictions can be visualized by mapping specific tissues to their parent anatomical regions.

Example:
- Model predicts: `brain - hippocampus` (UBERON_0002421)
- SVG only has: `cerebral cortex` (UBERON_0000955)
- Hierarchy fallback: `UBERON_0002421` → `UBERON_0000955`
- Result: Hippocampus prediction colors the brain cortex region

## Supporting Files

### uberon_descriptions.json
Maps UBERON IDs to human-readable anatomical region names and descriptions for tooltips.

```json
{
  "UBERON_0000955": {
    "label": "cerebral cortex",
    "description": "The outer layer of the cerebrum composed of folded grey matter..."
  }
}
```

### tissue_descendants.json
UBERON ontology hierarchy tree for intelligent fallback construction.

### svg_analysis_results.json
Metadata extracted from SVG files:
- All UBERON element IDs
- SVG structure analysis
- Coverage statistics

Generated by: `python anatomagram/utils/svg_analyzer.py`

## SVG Assets

### Anatomagram Files
Located in `anatomagram/assets/svg/`:
- `homo_sapiens.male.svg` - Male anatomagram (150 UBERON elements)
- `homo_sapiens.female.svg` - Female anatomagram (156 UBERON elements)
- `homo_sapiens.brain.svg` - Brain anatomagram (~50 UBERON elements)

### SVG Format
Elements use UBERON IDs as `id` attributes:
```xml
<g id="UBERON_0000955" inkscape:label="cerebral cortex">
  <path d="M..." fill="#E0E0E0" />
</g>
```

## Validation

### Check Mapping Coverage
```bash
python anatomagram/utils/validate_mappings.py
```

Validates:
- All `tissue_vocab.yaml` tissues have anatomagram mappings
- All SVG UBERON IDs are covered (direct or via hierarchy)
- No orphaned mappings

### Check SVG Element Coverage
```bash
python anatomagram/utils/validate_svg_mappings.py
```

Validates:
- All UBERON IDs in SVG files have mappings
- Reports unmapped elements
- Provides coverage statistics

### Visual Testing
```bash
# Test all anatomagram views
marimo edit notebooks/test_all_anatomagrams.py

# Test specific views
marimo edit notebooks/test_female_anatomagram.py
marimo edit notebooks/test_brain_anatomagram.py
```

## Relationship to vocabs/

**Two-layer architecture**:

```
Layer 1: vocabs/tissue_vocab.yaml
  ↓ (core model vocabulary)

Layer 2: anatomagram/data/tissue_mapping_enhanced.json
  ↓ (visualization extensions)

Output: Colored anatomagram SVGs
```

**Consistency guarantee**: All tissue IDs in `tissue_mapping_enhanced.json` correspond to keys in `tissue_vocab.yaml`.

## Deprecated Files

Moved to `.deprecated/` subdirectory:
- `tissue_uberon_mapping.json` - Superseded by enhanced version
- `tissue_uberon_mapping_manual.json` - Merged into enhanced version
- `tissue_to_uberon.csv` - Old CSV format

**Do not use these files.** Kept for historical reference only.

## Troubleshooting

### Tissue not coloring in anatomagram?

1. **Check tissue ID exists**:
   ```python
   import yaml
   vocab = yaml.safe_load(open('vocabs/tissue_vocab.yaml'))
   print('MY_TISSUE' in vocab.values())
   ```

2. **Check anatomagram mapping**:
   ```python
   import json
   mapping = json.load(open('anatomagram/data/tissue_mapping_enhanced.json'))
   tissue_id = list(vocab.keys())[list(vocab.values()).index('MY_TISSUE')]
   print(mapping['tissue_mappings'].get(tissue_id))
   ```

3. **Check SVG element exists**:
   ```bash
   python anatomagram/utils/validate_svg_mappings.py
   ```

4. **Enable debug mode**:
   ```python
   widget = AnatomagramWidget(
       visualization_data=data,
       selected_item="gene",
       sex="male",
       debug=True  # Check browser console
   )
   ```

### Female/brain anatomagram not showing tissues?

- Ensure female/brain-specific mappings exist in `tissue_mapping_enhanced.json`
- Run validation: `python anatomagram/utils/validate_svg_mappings.py`
- Check hierarchy fallbacks for region-specific tissues
- Enable debug mode to see unmapped UBERON IDs in browser console

### Tooltips not showing tissue names?

- Check that `uberon_descriptions.json` has entry for the UBERON ID
- Verify `uberon_names` traitlet is being passed to widget
- Enable debug mode to check data loading

## Adding New Tissues

When adding a new tissue to the model:

1. **Add to `vocabs/tissue_vocab.yaml`**:
   ```yaml
   new tissue name: <next_id>
   ```

2. **Add to `tissue_mapping_enhanced.json`**:
   ```json
   {
     "<next_id>": {
       "tissue_name": "new tissue name",
       "tissue_type": "tissue",
       "uberon_id": "UBERON_XXXXXXX",
       "svg_uberon_id": "UBERON_YYYYYYY",
       "is_direct_match": true,
       "can_visualize": true,
       "display_name": "Human Readable Name"
     }
   }
   ```

3. **Run validation**:
   ```bash
   python anatomagram/utils/validate_mappings.py
   python anatomagram/utils/validate_svg_mappings.py
   ```

4. **Test visualization**:
   ```bash
   marimo edit notebooks/test_all_anatomagrams.py
   ```

## Data Sources

- **UBERON Ontology**: http://uberon.github.io/
- **SVG anatomagrams**: Derived from Expression Atlas / GTEx visualizations
- **Tissue vocabularies**: DNA2Cell model training data

## Version History

- **v1.0** (Oct 2024): Initial enhanced mapping with hierarchy fallbacks
- **v1.1** (Oct 2024): Added brain region mappings and tissue descriptions
- **v1.2** (Oct 2024): 100% coverage for female and brain anatomagrams
